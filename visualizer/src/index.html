<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">

<!--Project dependencies
Leaflet
D3.js
Mapbox.com
-->





<head>

    <!-- <link rel="stylesheet" href="tabstyle.css"/> -->
    <link rel="stylesheet" href="pagestyle.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>


    <!--<link href='//mapbox.com/base/latest/base.css' rel='stylesheet' /> -->
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script src="createChart.js" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v4.min.js" type="text/javascript"></script>
    <script src="displayfunctions.js" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>


</head>

<body>

<h1>DNS Map</h1>


<!-- TAB FEATURES, WIP
<div class="tab">
    <button class="tablinks" onclick="openContent(event, 'MapWindow')">Map</button>
    <button class="tablinks" onclick="openMap(event, 'Statistics')">Statistics</button>
    <button class="tablinks" onclick="openContent(event, 'Test')">Test</button>
</div>


<div id="MapWindow" class="tabcontent">
    <div id="Map"></div>
    <script type="text/javascript">
        var queryMap = createMap();

    </script>
</div>

<div id="Statistics" class="tabcontent">
    <h3>Statistics</h3>
</div>

<div id="Test" class="tabcontent">
    <h3>Test</h3>
    <p>Test Content</p>
</div>
-->


<div id="Map" class="leafletMap"></div>

<div id="queryChartContainer" class="chart"></div>

<div id="sourceChartContainer" class="chart"></div>


<script type="text/javascript">
    // config variables //
    var sourceFile = "../../input/ExampleInput.csv";
    // config variables //

    d3.text(sourceFile, function(text) {    // read CSV file
        // config variables //
        var DNSServerLat = 43;
        var DNSServerLong = -77;
        // config variables //

        var data = d3.csvParseRows(text);
        var queryMarkers = [];
        var queryLines = [];

        // latLng object with DNS server coordinates
        var DNSServerCoords = L.latLng(DNSServerLat, DNSServerLong);

        // center of map
        var centerCoords = DNSServerCoords;

        // Create map
        var Map = L.map("Map").setView([0, 0], 2, {
            worldCopyJump: true
        });

        // Retrieve map tile from mapbox
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© ' +
            '<a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 10,
            minZoom: 2,
            center: centerCoords,
            id: 'mapbox.dark',
            noWrap: false,
            accessToken: 'pk.eyJ1IjoiY2NoZXNsZXkyMzk3IiwiYSI6ImNqYTR4endzNTMxY2sycXFyemduaXIxM3EifQ.gvT6NeQ0Q6ykY8PVzMhTTw'
        }).addTo(Map);

        // Options for DNS server map marker
        var serverMarkerOptions = {
            radius: 13,
            fillColor: "#42e5f4",
            color: 'black',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        // Options for query source markers


        var row;
        var queryCoords;
        var query;
        var country;
        var source;
        var validation;
        var validationColor;    // Red if DNSsec failed for query, green otherwise
        for (var i = 0; i < data.length; i++) {
            row = data[i];
            source = row[4];
            query = row[5];
            country = row[11];
            validation = row[15];

            validationColor = "#00c153";
            if (validation === "fail") {        // Check if requested DNSSec was invalid
                validationColor = "#c10a00";
            }
            var queryMarkerOptions = {
                radius: 7,
                fillColor: validationColor,
                color: 'black',
                weight: 1,
                opacity: .5,
                fillOpacity: 0.5
            };

            queryCoords = L.latLng(row[13], row[14]);

            var toolTip = '' +
                "Source: " + source + "<br>" +
                "Query: " + query + "<br>" +
                "Country: " + country + "<br>" +
                queryCoords + "<br>";

            // add new circle marker for query to queryMarkers list
            queryMarkers.push(new L.circleMarker(queryCoords, queryMarkerOptions)
                .bindTooltip(toolTip)
                .addTo(Map));
            var pointA = queryCoords;
            var pointB = DNSServerCoords;
            var pointList = [pointA, pointB];

            validationColor = "#42e5f4";
            if (validation === "fail") {    // check if requested DNSSec was invalid
                validationColor = "#c10a00";
            }

            //  Add new polyline linking source and DNS server
            queryLines.push(new L.polyline(pointList, {
                color: validationColor,
                weight: 3,
                opacity: 0.5,
                smoothFactor: 1
            }).addTo(Map));
        }


        var DNSServerCircle = L.circleMarker(DNSServerCoords, serverMarkerOptions).addTo(Map).bindPopup("DNS Server");


        var qChart = createQueryChart(data);    // create chart with frequency of each query
        var sChart = createSourceChart(data);   // create chart with frequency of each source IP
        Map.invalidateSize(true);               // resize map
    });
</script>








</body>

</html>